<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title>BOOT - Bootstrap Table</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link href="../../../base/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../../../base/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../../../base/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
    <link href="../../../base/css/animate.css" rel="stylesheet">
    <link href="../../../base/css/style.css?v=4.1.0" rel="stylesheet">
	<link href="../../../base/plugins/treegrid/css/jquery.treegrid.css" rel="stylesheet">
	<link href="../../../base/css/plugins/toastr/toastr.min.css" rel="stylesheet">
    <style type="text/css">    
	    .modal-header {
			padding: 10px  !important; 
		}	
	    .modal-footer {
			padding: 5px  !important;
	    }
	    .form-group {
			margin-bottom: 3px !important;
		}
	    h4 {
			font-size: 24px !important;		
		}
		.col-sm-8 {
			margin-bottom: 5px;
		}
		.keep-open{
			margin-top: -10px;
		}
		.ontr{
			background-color: #DBDBDB;
		}
		.buttom-left{
			margin-left: 5px;
		}
		.title-top{
			margin-top: 7px;
		}
		</style> 
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
    	
      <div class="col-sm-8"> 
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5 class="title-top">功能菜单管理  </h5>
                <div class="ibox-tools buttom-left title-top">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#">选项1</a>
                        </li>
                        <li><a href="#">选项2</a>
                        </li>
                    </ul>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
                <div style="height:40px">
		        	<button id="delbutton" class="btn btn-danger pull-right buttom-left" data-toggle="modal">
		            	<i class="fa fa-warning"></i>删除</button>
		            <button id="modify" class="btn btn-default pull-right buttom-left" ><i class="fa fa-paste"></i>修改</button>
		            <button id="addchild" class="btn btn-success pull-right buttom-left" ><i class="fa fa-plus"></i>添加子节点</button>
		            <button id="addparent" class="btn btn-success pull-right buttom-left"><i class="fa fa-plus"></i>添加根节点</button>
		        </div>
             </div>   
                <div class="ibox-content"  style="display: block;overflow: auto;height: 461px;"> 
                	
                 <table id="treegrids" class="table tree-2 table-bordered  table-condensed">
                 	<thead><tr>
                 		<th data-field="funcnm" tabindex="0"><div class="th-inner ">功能名称</div><div class="fht-cell"></div></th>
                 		<th data-field="funcid" tabindex="0"><div class="th-inner ">功能代码</div><div class="fht-cell"></div></th>
                 		<th data-field="page" tabindex="0"><div class="th-inner ">关联页面</div><div class="fht-cell"></div></th>
                 		<th data-field="sortno" tabindex="0"><div class="th-inner ">排序码</div><div class="fht-cell"></div></th>
                 		<th data-field="isvalid" tabindex="0"><div class="th-inner ">启用标志</div><div class="fht-cell"></div></th>
                 		</tr>
                 	</thead>			
					<tbody id="treebody"></tbody>
			     </table>	
           	</div>
          </div> 
      </div>
   
      <div class="col-sm-4">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>功能菜单管理  </h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-wrench"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#">选项1</a>
                        </li>
                        <li><a href="#">选项2</a>
                        </li>
                    </ul>
                    <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
             </div> 
                <div class="ibox-content">
                 <form class="form-horizontal" id="functionform">
		           <div class="form-group">
		           		<input type="text" id="fun_leaf" name="leaf" hidden="hidden" value="true"/>
		           		<input type="text" id="fun_parents" name="parents" hidden="hidden" value="true"/>
		                <label class="col-sm-4 control-label">上级菜单：</label> 
		                <div class="col-sm-8">
		                    <input type="text" placeholder="上级菜单名称" class="form-control" id="fun_parentname" name="parentname" readonly="readonly"> <span class="help-block m-b-none"></span>
		                </div>
		                <label class="col-sm-4 control-label">功能代码：</label> 
		                <div class="col-sm-8">
		                    <input type="text" placeholder="功能代码" class="form-control" id="fun_funcid" name="funcid" readonly="readonly"> <span class="help-block m-b-none"></span>
		                </div>
		                <label class="col-sm-4 control-label">功能名称：</label> 
		                <div class="col-sm-8">
		                    <input type="text" placeholder="功能名称" class="form-control" id="fun_funcnm" name="funcnm" required="required"> <span class="help-block m-b-none">请输入功能名称</span>
		                </div>
		                <label class="col-sm-4 control-label">关联页面：</label> 
		                <div class="col-sm-8"> 
		                    <input type="text" placeholder="关联页面" class="form-control" id="fun_page" name="page"> <span class="help-block m-b-none">请输入关联页面</span>
		                </div>
		                <label class="col-sm-4 control-label">功能图标：</label> 
		                <div class="col-sm-8"> 
		                    <input type="text" placeholder="功能图标" class="form-control" id="fun_icon" name="icon"> <span class="help-block m-b-none">请输入功能图标</span>
		                </div>
		                <label class="col-sm-4 control-label">启用标志：</label> 
		                <div class="col-sm-8">
		                  <select class="form-control m-b" id="fun_isvalid" name="isvalid">
		                      <option value="1">启用</option>
		                      <option value="0">不启用</option> 
		                  </select>
		                </div>
		                <label class="col-sm-4 control-label">排序码：</label> 
		                <div class="col-sm-8">
		                    <input type="text" placeholder="排序码" class="form-control" id="fun_sortno" name="sortno"> <span class="help-block m-b-none">请输入排序码</span>
		                </div>
		                <input type="reset" id="reset" hidden="hidden" />
		            </div> 
		        </form>
		        <div style="height: 50px;">
		        	<button type="button" id="save" class="btn btn-success pull-right"><i class="fa fa-plus"></i>保存</button>
		        </div>
                <div class="modal inmodal fade" id="myModal3" tabindex="-1" role="dialog"  aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title">确认删除</h4>
                            </div>
                            <div class="modal-body">
                                <p><strong>注意！</strong> 请确认是否要删除该数据，一旦删除无法恢复！</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="delsure">确认</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div> 
      </div>
    </div>

    <!-- 全局js -->
    <script src="../../../base/js/jquery.min.js?v=2.1.4"></script>
    <script src="../../../base/js/bootstrap.min.js?v=3.3.6"></script>
    <script src="../../../base/js/plugins/toastr/toastr.min.js"  type="text/javascript"></script>

    <!-- 自定义js -->
    <script src="../../../base/js/content.js?v=1.0.0"></script>
 	<script src="../../../base/plugins/treegrid/js/jquery.treegrid.js"  type="text/javascript"></script>
     
    <script type="text/javascript" >
     	var selectrow;
     	
     	$(function(){
     		
     		loaddata();
     		//提示消息 
     		toastr.options = {
			  	"closeButton": true,
			  	"debug": false,
			 	"progressBar": true,
			 	"positionClass": "toast-top-right",
			  	"onclick": null,
			  	"showDuration": "400",
			  	"hideDuration": "1000",
			  	"timeOut": "7000",
			  	"extendedTimeOut": "1000",
			  	"showEasing": "swing",
			  	"hideEasing": "linear",
			  	"showMethod": "fadeIn",
			  	"hideMethod": "fadeOut"
			};
          	//保存 
          	$("#save").click(function(){
	          	if($("#fun_funcnm").val() == "" || !$("#fun_funcnm").val()){
	          		toastr.error("功能名称不能为空！");
	          		return;
	          	}
	          	var data = $("#functionform").serializeObject();
				$.ajax({
					url : "/bootsystem/SysFunc/savefunc",
					type : "post",
					dataType : "text",
					data : {jstr: JSON.stringify(data)},
					success : function(result){
						if(result == "success"){
							toastr.success("保存成功！");
						}else
							toastr.error("保存失败");
						$("#treebody").html("");
						$("#reset").trigger("click");
						loaddata();
					}
				});
          	});
          	//增加根节点 
          	$("#addparent").click(function(){
	          	$("#reset").trigger("click");
	          	$("#fun_parents").val(0);
	          	$("#fun_parentname").val("根目录菜单");
	          	$.ajax({
					url : "/bootsystem/SysFunc/sysfuncNID",
					type : "post",
					dataType : "text",
					success : function(result){
						$("#fun_funcid").val("insert_"+result);
					}
				});
          	});
          	//增加子节点 
          	$("#addchild").click(function(){
	          	$("#reset").trigger("click");
		          	if(!selectrow){
		          		toastr.warning("请选择上级菜单！");
		          		return;
		          	}
	          	$("#fun_parents").val(selectrow.funcid);
	          	$("#fun_parentname").val(selectrow.funcnm);
	          	$.ajax({
					url : "/bootsystem/SysFunc/sysfuncNID",
					type : "post",
					dataType : "text",
					success : function(result){
						$("#fun_funcid").val("insert_"+result);
					}
				});
          	}); 
          	//修改节点 
          	$("#modify").click(function(){
          		if(!selectrow){
          			toastr.warning("请选择一个功能节点！");
          			return;
          		}
        		for(var key in selectrow){
					$("#fun_"+key).val(selectrow[key]);
				}
          	});    
          	
          	//删除按钮  //删除节点 
    		$("#delbutton").click(function(){
    			if(!selectrow){
    				toastr.warning("请选择一个功能点！");
       				return;
         		}
    			var children = selectrow["chindren"];
    			if(children != null){
           			toastr.warning("删除的菜单下还有子菜单不能删除!");
      				return;
           		}
           		$("#myModal3").modal('show');
    		});
    		$("#delsure").click(function(){  //删除确认 
    			$.ajax({
    				url : '/bootsystem/SysFunc/delsysfunc',
    				type : 'post',
    				dataType : 'text',
    				data : {
    					'node' : selectrow.funcid,
    					'parents' : selectrow.parents 
    				},
    				success : function(result){
    					if(result == 'success'){
    						toastr.success("删除成功！");
    					}else{
    						toastr.error("删除失败！");
    					}
    					$("#treebody").html("");
    					loaddata();
    				}
    			});
    		});
                  
     	}); //ready end 
     	
     	
     	//页面加载数据 
     	function loaddata(){
	     	$.ajax({
	          	url:"/bootsystem/SysFunc/info",
	          	dataType:"json",
	          	success:function(res){
	          		var data = transData(res, "funcid", "parents", "chindren");
	          		loadchildren(data, "根目录菜单");
	          		$(".tree-2").treegrid({
	              		expanderExpandedClass: "glyphicon glyphicon-minus",
	              		expanderCollapsedClass: "glyphicon glyphicon-plus",
	              		initialState: "collapsed"
	          		});
	          	}
	        });
     	}
     	//行点击事件 
     	$("#treebody").delegate("tr","click",function(){
			$(this).addClass("ontr").siblings("tr").removeClass("ontr");
			selectrow = JSON.parse($(this).attr("data-row"));
		});
     	
     	//遍历子节点 
     	function loadchildren(children,parentname){
     		for(var i in children){
     			var row=children[i];
     			row.parentname=parentname;
     			var tr=$("<tr id='tg_"+row.funcid+"' data-row='"+JSON.stringify(row)+"'></tr>").addClass("treegrid-"+row.funcid).appendTo($("#treebody"));
         		if(row.parents!=0){
         			tr.addClass("treegrid-parent-"+row.parents);
         		}
   				var obj={
   					funcnm: row.funcnm,
   					funcid: row.funcid,
   					page: row.page,
    				sortno: row.sortno,
    				isvalid: row.isvalid=="1"?"启用":"不启用",
   				};
       			for(var key in obj){
       				$("<td></td>").text(obj[key]).appendTo(tr);
       			}
       			var data = row.chindren;
        		if(data != null){
        			loadchildren(data, row.funcnm);	
        		}
     		}
     	}
     	
     	
     	//解析json 
     	function transData(jsons, idStr, pidStr, chindrenStr){  
		    var r = [], hash = {};
		    var id = idStr, pid = pidStr, children = chindrenStr;
		    var i = 0, j = 0, len = jsons.length;  
		    for(; i < len; i++){  
		        hash[jsons[i][id]] = jsons[i];  
		    }  
		    for(; j < len; j++){  
		        var aVal = jsons[j], hashVP = hash[aVal[pid]];  
		        if(hashVP){  
		            !hashVP[children] && (hashVP[children] = []);  
		            hashVP[children].push(aVal);  
		        }else{  
		            r.push(aVal);  
		        }  
		    }  
		    return r;  
		} 
     	//form表单转为json，key-val  name-value 
     	$.fn.serializeObject = function(){  
     	   var o = {};  
     	   var a = this.serializeArray();  
     	   $.each(a, function() {  
     	       if (o[this.name]) {  
     	           if (!o[this.name].push) {  
     	               o[this.name] = [o[this.name]];  
     	           }  
     	           o[this.name].push(this.value || '');  
     	       } else {  
     	           o[this.name] = this.value || '';  
     	       }  
     	   });  
     	   return o;  
     	};
     </script>
    

</body>

</html>
